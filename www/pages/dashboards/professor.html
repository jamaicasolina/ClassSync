<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Professor Dashboard - ClassSync</title>
    <link rel="stylesheet" href="../../css/main.css" />
    <link rel="stylesheet" href="../../css/dashboard.css" />
    <style>
        .schedule-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .toggle-btn {
            padding: 8px 16px;
            border: 1px solid white;
            background: whitesmoke;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
        }
        .toggle-btn.active {
            background: maroon;
            color: white;
            border-color: maroon;
        }
        .day-schedule {
            margin-bottom: 15px;
        }
        .day-schedule h4 {
            background: rgb(241, 241, 114);
            padding: 10px;
            margin: 0 0 10px 0;
            border-left: 4px solid maroon;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">

    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>ClassSync</h2>
            <p class="user-role">Professor</p>
        </div>
        <nav class="sidebar-nav">
            <a href="professor.html" class="nav-item active">ðŸ“Š Dashboard</a>
            <a href="../professor/courses.html" class="nav-item">ðŸ“š Courses</a>
            <a href="../professor/schedules.html" class="nav-item">ðŸ“… Schedules</a>
            <a href="../professor/attendance.html" class="nav-item">âœ“ Attendance</a>
            <a href="../professor/notifications.html" class="nav-item">ðŸ”” Notifications</a>
            <a href="../profile.html" class="nav-item">ðŸ‘¤ Profile</a>
            <a href="#" class="nav-item" id="logoutBtn">ðŸšª Logout</a>
        </nav>
  </aside>

  <main class="main-content">

    <header class="content-header">
      <h1>Welcome, <span id="professorName">Professor</span></h1>
      <button class="btn btn-primary" onclick="location.href='../professor/courses.html'">+ Add Course</button>
    </header>

    <div class="dashboard-grid">

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">ðŸ“š</div><h3 id="totalCourses">0</h3><p>Total Courses</p></div>
        <div class="stat-card"><div class="stat-icon">ðŸ‘¥</div><h3 id="totalStudents">0</h3><p>Total Students</p></div>
        <div class="stat-card"><div class="stat-icon">ðŸ“…</div><h3 id="todayClasses">0</h3><p>Today's Classes</p></div>
        <div class="stat-card"><div class="stat-icon">âœ“</div><h3 id="openSessions">0</h3><p>Open Attendance</p></div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>My Schedule</h2>
          <a href="../professor/schedules.html" class="link">View Full Schedule</a>
        </div>
        <div class="card-body">
          <div class="schedule-toggle">
            <button class="toggle-btn active" id="todayBtn">Today</button>
            <button class="toggle-btn" id="weekBtn">This Week</button>
          </div>
          <div id="professorSchedule"><p class="no-data">Loading schedule...</p></div>
        </div>
      </div>

    </div>
  </main>
</div>

<script src="../../js/core/roles.js"></script>
<script>
  requireRole('professor');
  const user = getSessionUser();
  if (user) document.getElementById('professorName').textContent = user.first_name;

  document.getElementById('logoutBtn').onclick = e => {
    e.preventDefault();
    if (confirm('Logout?')) logout();
  };

  const COURSE_API = "http://localhost/FINAL_PROJECT/ClassSync/api/controllers/CourseController.php";
  const SCHEDULE_API = "http://localhost/FINAL_PROJECT/ClassSync/api/controllers/ScheduleController.php";

  let allSchedules = [], currentView = 'today';

  const todayBtn = document.getElementById('todayBtn'),
        weekBtn = document.getElementById('weekBtn'),
        professorSchedule = document.getElementById('professorSchedule');

  todayBtn.onclick = () => showScheduleView('today');
  weekBtn.onclick = () => showScheduleView('week');

  async function loadDashboardData() {
    try {
      const courseData = await (await fetch(`${COURSE_API}?action=my_courses`)).json();
      if (courseData.success) {
        document.getElementById('totalCourses').textContent = courseData.courses.length;
        document.getElementById('totalStudents').textContent =
          courseData.courses.reduce((sum, c) => sum + +(c.enrolled_count || 0), 0);
      }

      const schedData = await (await fetch(`${SCHEDULE_API}?action=my_schedules`, {credentials: 'include'})).json();
      if (schedData.success) {
        allSchedules = schedData.schedules.filter(s => !s.is_cancelled);
        showScheduleView(currentView);
      } else {
        professorSchedule.innerHTML = '<p class="no-data">No schedules available.</p>';
      }
    } catch (e) {
      console.error(e);
    }
  }

  function showScheduleView(view) {
    currentView = view;
    todayBtn.classList.toggle('active', view === 'today');
    weekBtn.classList.toggle('active', view === 'week');
    view === 'today' ? showTodaySchedule() : showWeekSchedule();
  }

  function showTodaySchedule() {
    const today = new Date().toLocaleDateString('en-US', {weekday: 'long'}).toLowerCase(),
          list = allSchedules.filter(s => s.day_of_week === today);
    if (!list.length) return professorSchedule.innerHTML = '<p class="no-data">No classes today.</p>';
    list.sort((a,b) => a.start_time.localeCompare(b.start_time));
    professorSchedule.innerHTML = `
      <table class="table">
        <thead><tr><th>Time</th><th>Course</th><th>Room</th></tr></thead>
        <tbody>
          ${list.map(s => `
            <tr>
              <td>${formatTime(s.start_time)} - ${formatTime(s.end_time)}</td>
              <td><strong>${s.course_code}</strong><br>${s.course_name}</td>
              <td>${s.room_number || 'TBA'}</td>
            </tr>`).join('')}
        </tbody>
      </table>`;
  }

  function showWeekSchedule() {
    const days = ['monday','tuesday','wednesday','thursday','friday','saturday'];
    let html = '', hasData = false;
    days.forEach(day => {
      const dayList = allSchedules.filter(s => s.day_of_week === day);
      if (dayList.length) {
        hasData = true;
        html += `<div class="day-schedule"><h4>${day.toUpperCase()}</h4><table class="table"><tbody>
          ${dayList.map(s => `
            <tr>
              <td>${formatTime(s.start_time)} - ${formatTime(s.end_time)}</td>
              <td>${s.course_code} - ${s.course_name}</td>
              <td>${s.room_number || 'TBA'}</td>
            </tr>`).join('')}
          </tbody></table></div>`;
      }
    });
    professorSchedule.innerHTML = hasData ? html : '<p class="no-data">No classes this week.</p>';
  }

  const formatTime = t => {
    const [h,m] = t.split(':'), hr = h % 12 || 12;
    return `${hr}:${m} ${h >= 12 ? 'PM' : 'AM'}`;
  };

  document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
</body>
</html>
